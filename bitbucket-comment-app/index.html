<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Enter Your Comment</title>
	<link rel="stylesheet" href="simplemde.min.css">
	<link rel="stylesheet" href="bootstrap.min.css">
</head>

<body>
	<textarea id="markdown-editor">
	</textarea>
	<button id="cancelBtn" type="button" class="btn btn-outline-secondary float-right" style="margin-right: 10px">Cancel</button>
	<button id="saveBtn" type="button" class="btn btn-outline-primary float-right" style="margin-right: 5px">Save</button>

	<script src="simplemde.min.js"></script>
	<script src="bootstrap.min.js"></script>
	<script>
		// Editor
		var simplemde = new SimpleMDE({
			element: document.getElementById("markdown-editor"),
			autofocus: true,
			placeholder: "Write your comment..."
		});
		require('./renderer.js');
		const { ipcRenderer } = require('electron');
		// init the editor with incoming value
		ipcRenderer.on('init.editor', function (event, arg) {
			// some conversions for BitBucket Markdown integration
			// see the gitlab ticket for details
			arg = arg.replace(/\u200C/g, '');
			arg = arg.replace(/\n\n/g, '\n');
			simplemde.value(arg);
		})

		var saveBtn = document.getElementById('saveBtn');
		var cancelBtn = document.getElementById('cancelBtn');

		saveBtn.addEventListener('click', function () {
			// some conversions for BitBucket Markdown integration
			// see the gitlab ticket for details
			let replacedVal = simplemde.value().replace(/\n/g, '\n\n');
			replacedVal = replacedVal.replace(/\n\n\n\n/g, '\n\n\u200C\n\n');
			replacedVal = replacedVal.replace(/\n\n\n\n/g, '\n\n\u200C\n\n');
			ipcRenderer.send('save.comment', replacedVal);
		})

		cancelBtn.addEventListener('click', function () {
			ipcRenderer.send('close');
		})

		// send ui.ready message to main process when the window loaded
		window.addEventListener('load', function () {
			ipcRenderer.send('ui.ready');
		})

		// binding ESC to Cancel, and Shift+Enter to Save
		document.onkeydown = function (e) {
			e = e || window.event;
			switch (e.which || e.keyCode) {
				// ESC
				case 27:
					cancelBtn.click();
					break;
				case 13:
					if (e.shiftKey) {
						// shift + enter
						saveBtn.click();
					}
			}
		}
	</script>
</body>

</html>